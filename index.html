<!-- bullet_to_table.html -->

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<meta charset="UTF-8">
		<title>Bullets to Table</title>
		<link rel="stylesheet" href="sources/bootstrap.min.css">
		<link rel="stylesheet" href="sources/font-awesome-all.min.css">
		<style>
			textarea {
				/*margin: 50;*/
				width: 100%;
				/*height: 300px;*/
			}

			table {
				/*margin: 50;*/
				width: 100%;
				background-color: #fff !important;
				margin-bottom: 30px !important;
			}

			td {
				vertical-align: top;
			}

			table.table-bordered td {
			  border:1px solid #aaa;
			}

			.navbar, footer {
				background-color: #292c3e !important;
			}

			.navbar > a {
				color: rgba(255,255,255,0.9) !important;
			}

			body {
				background-color: #f5f5f5;
			}

			.btn-copy-clipboard:focus {
				box-shadow: none;
			}

		</style>
	</head>

	<body class="d-flex flex-column h-100">
		<main role="main" class="flex-shrink-0">

			<nav class="navbar navbar-expand-lg navbar-light bg-light justify-content-center">
				<a href="#" class="navbar-brand" style="margin-right: 0; font-size: 2.75rem">Bullets to Table</a>

			</nav>


			<div class="container">
				<!-- <div class="row">
					<div class="col-sm">
						<form>
						  <p>Last line behaviour:</p>
						  <input type="radio" id="fully_indented" name="last_line_behaviour" value="fully_indented" checked>
						  <label for="fully_indented">Assume fully indented</label><br>
						  <input type="radio" id="ignore" name="last_line_behaviour" value="ignore">
						  <label for="ignore">Ignore line</label><br>
						  <input type="radio" id="custom_indent" name="last_line_behaviour" value="custom_indent">
						  <label for="custom_indent">Custom indent:</label>
						  <input type="number" id="custom_indent_value" name="custom_indent_value" value="" disabled>
						  <br>
						</form>
					</div>
				</div> -->
				<div class="row">
					<div class="col-sm">
						<br><br>
						<h5 class="text-center">Convert a bullet list into a table</h5>
						<br><br>
					</div>
				</div>

				<div class="row">
					<div class="col-1">
						<p><b>Input:</b></p>
					</div>
					<div class="col-10">
						<textarea id="input" rows="10"></textarea>
					</div>
					<div class="col-1">
					</div>
				</div>
				<div class="row">
					<div class="col-1">
						
					</div>

					<div class="col-10 d-flex justify-content-center">
						<svg class="bi bi-triangle-fill" width="1em" height="4em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" transform='rotate(180 0 0)'>
						  <path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/>
						</svg>
					</div>
					<div class="col-1">
					</div>
				</div>
				<div class="row">
					<div class="col-1">
						<p><b>Output:</b></p>
					</div>
					<div class="col-10">
						<table id="output" border="1" class="table table-bordered">
							<tr>
								<td>Empty table</td>
							</tr>
						</table>
					</div>
					<div class="col-1">
					</div>
				</div>
				<div class="row">
					<div class="col-1">
					</div>
					<div class="col-10 d-flex justify-content-center">
						<button class="btn btn-copy-clipboard" value="select table" style="margin-bottom: 40px" onclick="copy_to_clipboard();">
   							<svg id="copy-svg-empty" width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-clipboard" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
  <path fill-rule="evenodd" d="M9.5 1h-3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
</svg>
							<svg id="copy-svg-check" width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-clipboard-check d-none" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
  <path fill-rule="evenodd" d="M9.5 1h-3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3zm4.354 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
</svg>
							<p style="margin-top:10px; margin-bottom: 0px" id="copy-to-clipboard" class="">Copy to clipboard</p>
							<p style="margin-top:10px; margin-bottom: 0px" id="copied" class="d-none">Copied!</p>
   						</button>
					</div>
					<div class="col-1">
					</div>
				</div>
			</div>
		</main>

		<footer class="footer mt-auto py-3" style="background-color:#292c3e">
		  <div class="container-fluid">
		  	<div class="row">
		  		<div class="col-2">
				</div>
		  		<div class="col-8 d-flex justify-content-center">
		    		<span class="text-muted text-center mx-3" style="margin-bottom:0;">&copy; 2020 Suhail Idrees</span>
		    	</div>
		    	
		    	<div class="col-2 d-flex justify-content-end">
			    	<a class="text-muted text-center mx-3" target="_blank" href="https://github.com/suhail93/bullets_to_table" style="margin-bottom:0;"><i class="fab fa-github" style="font-size:1.5rem"></i></a>
				</div>

			</div>
		  </div>
		</footer>

	</body>





<script src="sources/jquery-3.5.1.min.js"></script>

<script src="sources/bootstrap.bundle.min.js"></script>

<script src="sources/ckeditor.js"></script>


<script>
	var input;
	var lines;
	var indents;
	var table_html;
	var n_rows;
	var n_cols;
	var min_indent;
	var table_rows;
	var input_rows;
	var indent_rows;

	// CONTROLS (initially set in doc.ready function which reads the radio button)
	var assume_last_line_fully_indented;
	var ignore_last_line;
	var custom_indent;
	var custom_indent_value;


	let editor;
     $( document ).ready(function() {
         ClassicEditor
		    .create( document.querySelector( '#input' ), {
		    	 toolbar: [ 'bulletedList', 'numberedList', "|", "outdent", "indent"],
        
		    } )
		    .then( newEditor => {
		        editor = newEditor;
		        editor.setData("<ul><li>Item 1<ul><li>Sub-item 1<ul><li>Sub-sub-item 1</li><li>Sub-sub-item 2</li></ul></li><li>Sub-item 2<ul><li>Sub-sub-item 3</li></ul></li></ul></li><li>Item 2<ul><li>Sub-item 3<ul><li>Sub-sub-item 4</li></ul></li></ul></li></ul>")
		        process_input();
		    } )
		    .catch( error => {
		        console.error( error );
		    } ); 


    });




	/* HELPER FUNCTION from yckart at https://stackoverflow.com/a/966938 */
	function createArray(length) {
	    var arr = new Array(length || 0),
	        i = length;
	    if (arguments.length > 1) {
	        var args = Array.prototype.slice.call(arguments, 1);
	        while(i--) arr[length-1 - i] = createArray.apply(this, args);
	    }
	    return arr;
	}

	/* HELPER FUNCTION from Dio at https://stackoverflow.com/a/38821410 */
	function selectElementContents(el) {
		var body = document.body, range, sel;
		if (document.createRange && window.getSelection) {
		    range = document.createRange();
		    sel = window.getSelection();
		    sel.removeAllRanges();
		    try {
		        range.selectNodeContents(el);
		        sel.addRange(range);
		    } catch (e) {
		        range.selectNode(el);
		        sel.addRange(range);
		    }
		} else if (body.createTextRange) {
		    range = body.createTextRange();
		    range.moveToElementText(el);
		    range.select();
		}
	document.execCommand("Copy");
	if (window.getSelection) {window.getSelection().removeAllRanges();}
 else if (document.selection) {document.selection.empty();}

}
	
	function copy_to_clipboard() {
		selectElementContents( document.getElementById('output') );
		$("#copy-svg-empty").addClass("d-none");
		$("#copy-svg-check").removeClass("d-none");
		$("#copy-to-clipboard").addClass("d-none");
		$("#copied").removeClass("d-none");
	}


	function get_lines_and_indents() {
		var temp = input;
		var current_indent_level = 0;
		var reached_end = false;
		lines = [];
		indents = [];
		while (reached_end == false) {
			var indexOf_ul_open = temp.indexOf("<ul>");
			var indexOf_ul_close = temp.indexOf("</ul>");
			var indexOf_ol_open = temp.indexOf("<ol>");
			var indexOf_ol_close = temp.indexOf("</ol>");
			var indexOf_li_open = temp.indexOf("<li>");
			var indexOf_li_close = temp.indexOf("</li>");

			if (indexOf_ul_open < 0) {
				indexOf_ul_open = 10000;
			}
			if (indexOf_ul_close < 0) {
				indexOf_ul_close = 10000;
			}
			if (indexOf_ol_open < 0) {
				indexOf_ol_open = 10000;
			}
			if (indexOf_ol_close < 0) {
				indexOf_ol_close = 10000;
			}
			if (indexOf_li_open < 0) {
				indexOf_li_open = 10000;
			}
			if (indexOf_li_close < 0) {
				indexOf_li_close = 10000;
			}

			var min_index = Math.min(indexOf_ul_open, indexOf_ul_close, indexOf_ol_open, indexOf_ol_close, indexOf_li_open, indexOf_li_close);

			console.log(temp);

			if (min_index == 10000) {
				reached_end = true;
				break;
			}

			// check which is the first tag to encounter
			if (indexOf_ul_open == min_index) {
				// simply count the indent increase and remove the tag from temp
				current_indent_level += 1;
				temp = temp.substring(min_index + 4); // 4 is the length of the tag
			}
			else if (indexOf_ul_close == min_index) {
				// simply count the indent decrease and remove the tag from temp
				current_indent_level -= 1;
				temp = temp.substring(min_index + 5); // 5 is the length of the tag
			}
			else if (indexOf_ol_open == min_index) {
				// simply count the indent increase and remove the tag from temp
				current_indent_level += 1;
				temp = temp.substring(min_index + 4); // 4 is the length of the tag
			}
			else if (indexOf_ol_close == min_index) {
				// simply count the indent decrease and remove the tag from temp
				current_indent_level -= 1;
				temp = temp.substring(min_index + 5); // 5 is the length of the tag
			}
			else if (indexOf_li_open == min_index) {
				// parse in a line continuing till the next tag
				var this_line = temp.substring(min_index + 4, min_index + 4 + temp.substring(min_index + 4).indexOf("<"))
				lines.push(this_line);
				indents.push(current_indent_level);
				console.log("line logged at indent level", current_indent_level, ": ", this_line)
				temp = temp.substring(min_index + 4 + temp.substring(min_index + 4).indexOf("<"))
			}
			else if (indexOf_li_close == min_index) {
				// ignore and move on
				temp = temp.substring(min_index + 5); // 5 is the length of the tag
			}

			if (temp.trim().length == 0) {
				reached_end = true;
			}

		}
	};

	function get_indents() {
		
		indents = [];

		// for each line, get the indent amount
		for (var i = 0; i < lines.length; i++) {
			var pointer = 0;
			while (lines[i][pointer] == "\t") {
				pointer += 1;
			}
			indents.push(pointer);
		}

		if (assume_last_line_fully_indented) {
			indents[indents.length-1] = Math.max(...indents);
		}
		else if (custom_indent) {
			indents[indents.length-1] = custom_indent_value;
		}

		console.log(indents);
	};

	function get_n_rows() {
		var count = 1; //for the last line which isn't included in the array below but is obviously a row as it's the end of a branch
		for (var i = 0; i < indents.length-1; i++) {
			if (indents[i+1] <= indents[i]) {
				count += 1;
			}
		}
		return count;
	};

	function get_n_cols() {
		return Math.max(...indents) - Math.min(...indents) + 1;
	};

	function get_min_indent() {
		return Math.min(...indents);
	};

	function trim_bullets_and_tab(text) {
		t = text.trim();
		if (t[1] == " ") {
			t = t.substring(2,)
		}
		return t
	}

	function get_table_rows() {
		/*var lines = input.split("\n");*/
		input_rows = [];
		indent_rows = [];
		var last_slice = 0;
		for (var i = 0; i < indents.length-1; i++) {
			if (indents[i+1] <= indents[i]) { // i.e. if this "i" corresponds to the end of a branch
				input_rows.push(lines.slice(last_slice, i+1));
				indent_rows.push(indents.slice(last_slice, i+1));
				last_slice = i+1;
			}
		}
		input_rows.push(lines.slice(last_slice, lines.length));
		indent_rows.push(indents.slice(last_slice, indents.length));

		console.log(input_rows);
		console.log(indent_rows);
	};


	function get_table_html() {
		/*var lines = input.split("\n");*/
		table_html = "";
		get_table_rows();
		
		var fill_boolean_array = createArray(n_rows, n_cols); // 2D array of true and false values to show if input contains an element for this cell

		for (var i = 0; i < n_rows; i++) {		
			for (var j = 0; j < n_cols; j++) {
				if (indent_rows[i].indexOf(j+min_indent)>-1) {
					fill_boolean_array[i][j] = true;
				}
				else {
					fill_boolean_array[i][j] = false;	
				}
			}
		}

		var fill_source = createArray(n_rows, n_cols); // 2D array of strings to show how we're filling a cell. Possible values: "direct from input" "from above", "empty cell"

		for (var i = 0; i < n_rows; i++) {		
			for (var j = 0; j < n_cols; j++) {
				if (fill_boolean_array[i][j] == false) {
					// check if there is a true to the left -- if yes, then it's a new row and needs a blank cell -- if not, then it's filled from above
					if (fill_boolean_array[i].slice(0,j).indexOf(true)>-1) {
						fill_source[i][j] = "empty cell";
					}
					else {
						fill_source[i][j] = "from above";
					}
				}
				else {
					fill_source[i][j] = "direct from input";
				}
			}
		}

		for (var i = 0; i < n_rows; i++) {		
			table_html = table_html + "<tr>"

			for (var j = 0; j < n_cols; j++) {
				console.log(i, j)
				if (fill_source[i][j] == "direct from input") {
					/*console.log(input_rows[i]);
					console.log(indent_rows[i]);
					console.log(indent_rows[i].indexOf(j+min_indent));*/
					console.log(input_rows[i][indent_rows[i].indexOf(j+min_indent)]);

					// check if there are "from above" in the cells below this one. if so, then add appropriate rowspan
					var this_row_span = 1;
					var streak_broken = false;
					console.log("searching for fill from above cells that are below this one: ", i, j)
					for (var k = 0; k < n_rows; k++) {
						if (k>i) {
							console.log(k);
							if (fill_source[k][j] == "from above" && streak_broken == false) {
								this_row_span += 1;
							}
							else {
								streak_broken = true;
							}
						}
					}

					table_html = table_html + "<td rowspan='" + this_row_span.toString() + "'>" + trim_bullets_and_tab(input_rows[i][indent_rows[i].indexOf(j+min_indent)]) + "</td>\n"
				}
				else if (fill_source[i][j] == "empty cell") {
					table_html = table_html + "<td>" + "</td>\n"
				}
				else if (fill_source[i][j] == "from above") {
					console.log("filling from above")
					/*table_html = table_html + "<td>" + "</td>\n"*/
				}
			}

			table_html = table_html + "</tr>\n"
		}

		console.log(fill_boolean_array);

	}


	$( document ).ready(function() {

		editor.model.document.on( 'change:data', () => {
    	console.log( 'The data has changed!' );
    	process_input();
	} );


		var temp = $('input[type=radio][name=last_line_behaviour]').val();
		switch (temp) {
			case 'fully_indented':
				assume_last_line_fully_indented = true;
				ignore_last_line = false;
				break;
			case 'ignore':
				assume_last_line_fully_indented = false;
				ignore_last_line = true;
				break;
		}
	});

	// when textarea gets an input, update the table
	$('#input').bind('input propertychange', function() {
		process_input();
	});

	
	// when radio options are changed, store variables and update the table
	$('input[type=radio][name=last_line_behaviour]').on('change', function() {
		switch ($(this).val()) {
			case 'fully_indented':
				assume_last_line_fully_indented = true;
				ignore_last_line = false;
				custom_indent = false;
				$("#custom_indent_value").attr("disabled", true);
				break;
			case 'ignore':
				assume_last_line_fully_indented = false;
				ignore_last_line = true;
				custom_indent = false;
				$("#custom_indent_value").attr("disabled", true);
				break;
			case 'custom_indent':
				assume_last_line_fully_indented = false;
				ignore_last_line = false;
				custom_indent = true;
				if (typeof indents !== 'undefined') {
					custom_indent_value = Math.max(...indents)
				}
				else {
					custom_indent_value = 0	
				}
				$("#custom_indent_value").val(custom_indent_value);
				$("#custom_indent_value").removeAttr("disabled");
				break;
			}
		process_input();
	});

	$('input[name=custom_indent_value]').bind('input propertychange', function() {

		custom_indent_value = parseInt($(this).val());
		
		process_input();
	});

	function process_input() {
		$("#copy-svg-empty").removeClass("d-none");
		$("#copy-svg-check").addClass("d-none");
		$("#copy-to-clipboard").removeClass("d-none");
		$("#copied").addClass("d-none");

		console.log("The text has been changed.");
		input = editor.getData();
		/*input = $('#input').val();*/
		/*input = input.substring(0,input.length-2)*/
		//lines = input.split("\n");
		
		get_lines_and_indents();

		if (lines.length == 0) {
			console.log("detected that no list tags")
			/*break;*/
		}
		else {
			n_rows = get_n_rows();
			n_cols = get_n_cols();
			min_indent = get_min_indent();
			console.log(n_rows);
			console.log(n_cols);
			get_table_html();
			$("#output").html(table_html);

		}
/*
		if (ignore_last_line) {
			lines.pop();
		}*/
		console.log(input);
		/*get_indents();*/



	}

</script>

</html>